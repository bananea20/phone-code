package com.skyui.aiengine.libcarport.module

import com.skyui.aiengine.libcore.AISDK
import org.opencv.core.MatOfPoint2f
import org.opencv.core.Point
import org.opencv.imgproc.Imgproc

class TextWindowFilter(version: Int = 0) : AbsTextFilter() {
    companion object {
        private const val TAG = "TextWindowFilter"
    }

    var version: Int = 0
    val width = listOf(1280.0, 1290.0)
    val height = listOf(1000.0, 1536.0)
    var map: MutableMap<String, List<Point>> = mutableMapOf()

    private val backContour: List<List<Point>> = listOf(
        listOf(
            Point(0.8247422680411773, 74.22680412371135),
            Point(1278.1443298969073, 73.19587628865979),
            Point(1279.0, 802.0),
            Point(881.2371134020618, 938.1443298969073),
            Point(528.659793814433, 948.4536082474227),
            Point(229.69072164948452, 873.1958762886599),
            Point(0.8247422680411773, 744.3298969072165)
        ),
        listOf(
            Point(107.61904761904754, 734.6666666666667),
            Point(334.6031746031745, 431.49206349206355),
            Point(679.047619047619, 244.19047619047623),
            Point(969.5238095238094, 207.68253968253973),
            Point(1256.8253968253966, 261.65079365079373),
            Point(1448.8888888888887, 348.952380952381),
            Point(1618.7301587301586, 480.69841269841277),
            Point(1696.5079365079364, 583.8730158730159),
            Point(1799.6825396825395, 755.3015873015873),
            Point(1774.285714285714, 925.1428571428572),
            Point(1720.3174603174602, 1099.7460317460318),
            Point(1640.9523809523807, 1096.5714285714284),
            Point(1512.3809523809523, 1163.2380952380952),
            Point(1325.0793650793648, 1245.7777777777778),
            Point(1163.1746031746031, 1290.2222222222222),
            Point(923.4920634920634, 1310.857142857143),
            Point(747.3015873015872, 1288.6349206349205),
            Point(567.936507936508, 1241.015873015873),
            Point(428.25396825396814, 1180.6984126984128),
            Point(325.079365079365, 1128.3174603174602),
            Point(255.23809523809513, 1099.7460317460318),
            Point(190.15873015873007, 1098.1587301587301),
            Point(140.95238095238085, 987.0476190476192),
            Point(113.96825396825386, 855.3015873015873)
        )
    )
    private val frontContour: List<List<Point>> = listOf(
        listOf(
            Point(0.8247422680411773, 77.31958762886597),
            Point(1276.0824742268042, 82.47422680412372),
            Point(1278.1443298969073, 997.9381443298969),
            Point(0.0, 998.0)
        ),
        listOf(
            Point(113.96825396825386, 620.3809523809524),
            Point(152.063492063492, 604.5079365079366),
            Point(204.44444444444434, 445.7777777777778),
            Point(307.61904761904754, 274.34920634920644),
            Point(459.99999999999994, 139.42857142857147),
            Point(642.5396825396824, 36.2539682539683),
            Point(734.6031746031745, 1.3333333333333837),
            Point(1090.0, 0.0),
            Point(1163.0, 0.0),
            Point(1348.8888888888887, 72.76190476190482),
            Point(1537.7777777777776, 206.09523809523813),
            Point(1661.5873015873015, 356.88888888888897),
            Point(1745.7142857142856, 515.6190476190477),
            Point(1771.111111111111, 607.6825396825398),
            Point(1812.380952380952, 618.7936507936508),
            Point(1817.142857142857, 701.3333333333334),
            Point(1848.888888888889, 739.4285714285714),
            Point(1837.7777777777776, 921.9682539682541),
            Point(1782.222222222222, 953.7142857142858),
            Point(1593.3333333333333, 1175.936507936508),
            Point(1382.2222222222222, 1334.6666666666665),
            Point(1117.1428571428569, 1428.3174603174602),
            Point(948.8888888888887, 1444.1904761904761),
            Point(745.7142857142856, 1421.968253968254),
            Point(563.1746031746031, 1358.4761904761904),
            Point(380.63492063492055, 1242.6031746031745),
            Point(250.47619047619042, 1098.1587301587301),
            Point(131.42857142857133, 964.8253968253969),
            Point(74.28571428571422, 933.0793650793652),
            Point(61.58730158730151, 834.6666666666667),
            Point(64.7619047619047, 742.6031746031747),
            Point(94.92063492063482, 706.0952380952382)
        )
    )
    private val leftContour: List<List<Point>> = listOf(
        listOf(
            Point(4.948453608247377, 72.16494845360825),
            Point(1279.0, 78.0),
            Point(1279.0, 654.0),
            Point(1014.2268041237114, 794.8453608247423),
            Point(656.4948453608248, 883.5051546391753),
            Point(321.4432989690721, 822.680412371134),
            Point(5.979381443298934, 636.0824742268042)
        ),
        listOf(
            Point(145.7142857142856, 879.1111111111112),
            Point(96.50793650793645, 807.6825396825398),
            Point(107.61904761904754, 547.3650793650794),
            Point(153.65079365079356, 320.38095238095246),
            Point(277.4603174603174, 125.1428571428572),
            Point(376.0, 0.0),
            Point(1598.0, 0.0),
            Point(1702.8571428571427, 87.0476190476191),
            Point(1790.15873015873, 199.7460317460318),
            Point(1875.8730158730157, 352.1269841269842),
            Point(1909.2063492063492, 499.7460317460318),
            Point(1919.0, 517.0),
            Point(1919.0, 963.0),
            Point(1833.015873015873, 936.2539682539683),
            Point(1759.9999999999998, 972.7619047619048),
            Point(1615.5555555555554, 1112.4444444444443),
            Point(1455.2380952380952, 1225.142857142857),
            Point(1388.5714285714284, 1275.936507936508),
            Point(1312.3809523809523, 1355.3015873015872),
            Point(1093.3333333333333, 1436.2539682539682),
            Point(864.7619047619046, 1439.4285714285713),
            Point(617.1428571428571, 1377.5238095238094),
            Point(420.3174603174602, 1260.063492063492),
            Point(304.4444444444444, 1145.7777777777778),
            Point(290.15873015873007, 1060.063492063492)
        )
    )
    private val rightContour: List<List<Point>> = listOf(
        listOf(
            Point(1.8556701030927343, 71.1340206185567),
            Point(1277.1134020618556, 77.31958762886597),
            Point(1276.0824742268042, 617.5257731958764),
            Point(957.5257731958764, 837.1134020618557),
            Point(628.659793814433, 901.0309278350516),
            Point(329.69072164948454, 841.2371134020618),
            Point(187.42268041237108, 734.020618556701),
            Point(31.752577319587573, 634.020618556701),
            Point(2.886597938144291, 607.2164948453608)
        ),
        listOf(
            Point(28.25396825396814, 926.7301587301588),
            Point(4.444444444444343, 566.4126984126984),
            Point(79.04761904761898, 315.6190476190477),
            Point(220.3174603174602, 107.68253968253973),
            Point(304.4444444444444, 4.507936507936558),
            Point(1655.2380952380952, 1.3333333333333837),
            Point(1758.412698412698, 223.5555555555556),
            Point(1864.7619047619048, 518.7936507936508),
            Point(1869.5238095238094, 709.2698412698413),
            Point(1864.7619047619048, 817.2063492063493),
            Point(1796.5079365079362, 869.5873015873017),
            Point(1704.4444444444443, 1017.2063492063493),
            Point(1625.0793650793648, 1101.3333333333333),
            Point(1623.4920634920634, 1142.6031746031745),
            Point(1453.6507936507935, 1291.8095238095239),
            Point(1179.0476190476188, 1398.1587301587301),
            Point(948.8888888888887, 1421.968253968254),
            Point(736.1904761904761, 1388.6349206349205),
            Point(599.6825396825395, 1323.5555555555554),
            Point(512.3809523809523, 1290.2222222222222),
            Point(453.65079365079356, 1175.936507936508),
            Point(377.4603174603174, 1082.2857142857142),
            Point(313.9682539682539, 1031.4920634920634),
            Point(263.1746031746031, 1009.2698412698413),
            Point(239.36507936507923, 1015.6190476190477),
            Point(194.92063492063482, 968.0000000000001),
            Point(150.47619047619037, 934.6666666666667),
            Point(106.03174603174597, 906.0952380952382)
        )
    )

    fun check(point: Point, cam: String): Boolean {
        val lst = map[cam]
        var mat = MatOfPoint2f()
        mat.fromList(lst)
        //AISDK.logger()?.i(TAG, "cam $cam, contour size ${lst?.size}, point ${point.x} ${point.y}")
        val r = Imgproc.pointPolygonTest(mat, point, false)
        return r < 0
    }

    override operator fun invoke(text: String, info: List<InnerOCR>): List<InnerOCR> {
        var wls: MutableList<InnerOCR> = mutableListOf()
        for (e in info) {
            val p = Point(
                e.text.box.sumOf { it.x.toDouble() } / 4 / e.text.width,
                e.text.box.sumOf { it.y.toDouble() } / 4 / e.text.height
            )
            if (check(p, e.camera)) {
                AISDK.logger()?.i(
                    TAG,
                    "$text filtered by window from camera ${e.camera}, shape ${e.text.width}X${e.text.height}."
                )
                continue
            }
            wls.add(e)
        }
        if (wls.size < info.size) {
            AISDK.logger()?.i(
                TAG,
                "$text filtered by window, size decreased from ${info.size} to ${wls.size}."
            )
        }
        return wls
    }

    init {
        this.version = version
        AISDK.logger()?.i(TAG, "use version ${this.version}")
        for (c in listOf("BACK", "FRONT", "LEFT", "RIGHT")) {
            var lst: MutableList<Point> = mutableListOf()
            val ps = when (c) {
                "FRONT" -> frontContour
                "LEFT" -> leftContour
                "RIGHT" -> rightContour
                else -> backContour
            }
            for (e in ps[this.version]) {
                lst.add(Point(e.x / width[this.version], e.y / height[this.version]))
            }
            map[c] = lst
        }
    }
}